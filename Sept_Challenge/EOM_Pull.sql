--Had to account for duplicate programs_ids so grabbed max workouts done by TITLE, then lumped them into same "Series Name"
-- List of user_ids is the removing the mid_month users as there isn't a magnet for each series, just 1 and done
WITH dups_removed AS (
        SELECT user_id, programs_id, workout_id, title, duration,
        CASE WHEN programs_id IN ('5f340d02ba026d003716a165','5f57b6f2fbe59c003add0bd7') THEN 'Strengthen the Mind'
             WHEN programs_id = '5f121d3e2ff7e7007f3720bf' THEN 'Outdoor HIIT Strength'
             WHEN programs_id IN ('5f121ee9e020ae00f1335508','5f174849b526c1002ecae9d2') THEN 'Power Walking Intervals'
             WHEN programs_id IN ('5f174678ce7af400355e2702','5f174f6a5bed99002d4fd9b4') THEN 'Intro to Endurance Jogging'
             WHEN programs_id = '5f17549c65904d0034e9659e' THEN 'Heartward Yoga Series'
             END AS series_name
        FROM (
        SELECT ROW_NUMBER() OVER (PARTITION BY user_id, title ORDER BY duration DESC) as ord_events, user_id, programs_id, workout_id, "title", duration
        FROM (
        SELECT ul.*, pw.programs_id, ws."title",
        ROUND((duration / 1000 / ws.target_value),2) as percent_complete
        from unique_logs ul
        join prodmongo.programs__workouts pw on ul.workout_id = pw.workouts
        join workout_store.workouts ws on ul.workout_id = ws._id
        join prodmongo.users u on ul.user_id = u._id
        where programs_id IN ('5f340d02ba026d003716a165',
                '5f57b6f2fbe59c003add0bd7',
                '5f121d3e2ff7e7007f3720bf',
                '5f121ee9e020ae00f1335508',
                '5f174849b526c1002ecae9d2',
                '5f174678ce7af400355e2702',
                '5f174f6a5bed99002d4fd9b4',
                '5f17549c65904d0034e9659e')
        AND CONVERT_TIMEZONE(personal__tz,start_minute)::date BETWEEN '2020-09-01' AND '2020-09-30'
        )
        WHERE percent_complete >= 0.70
        )
        WHERE ord_events = 1
)
SELECT distinct(user_id), login__ifit__email, personal__firstname, personal__lastname, shipping__street1, 
        shipping__city, shipping__state, shipping__zip, shipping__country, domestic_user
FROM ( 
SELECT * --LAG (series_name,1) OVER (PARTITION BY user_id ORDER BY series_name) as other_completed 
FROM (
SELECT user_id, u.login__ifit__email, u.personal__firstname, u.personal__lastname,
    u.shipping__street1, u.shipping__city, u.shipping__state, u.shipping__zip, 
    u.shipping__country, 
    CASE WHEN shipping__country = 'US' THEN 1
    ELSE 0
    END AS domestic_user,
    series_name, 
    count(*) AS series_count
from dups_removed
join prodmongo.users u on dups_removed.user_id = u._id
group by user_id, series_name, 2,3,4,5,6,7,8,9
)
WHERE series_count >= 6 
AND user_id NOT IN ('5cfc751fe68b9d002fd648f6',
'5de007b0b46dae0187fac555',
'5eac70a9a7ac54003010720d',
'5e583553496f8d002a2ae5c8',
'52c18a20442924c35700119e',
'5e9ce958c7732f01a4ca5927',
'5dfeb4dc8ffb2e016fc40a22',
'530033c06a94b63c050000f6',
'5c677c4ad9061c002e31699c',
'5f452d12a17fc6002a685855',
'5e48a9c82ab82c05ddba36f6',
'5ea2eb19086da00085e366a0',
'5f1de3a448128e010094a33a',
'5ec53967923c5a00829f7445',
'5ebb51e058c6d600f44605ae',
'5e4c45f371c4f3003dad08c6',
'5ea0e6e3df210e0136835153',
'5e9b2edf932822002c9fe681',
'5ea49f80a7a178002fa22c04',
'5cca1b6379069e002de86d73',
'57cf7c7fe291862800a5d8a9',
'5df51bc6815b0900e4995fc7',
'5a4fb6cd2baef200404c9688',
'5e8e6c260348dc0030334ec3',
'5f0647c6778d140086e26c89',
'5df972d12546950260978768',
'5ec3096f3345bf002d91bd69',
'5e50402454c3b600331849de',
'5e97a49fdd52f8002c06f43f',
'5efb8b90d20b5b002c024d77',
'5dbd7adb78b29e002cee681e',
'5e9f9f2fde1c5a002da5ce9b',
'5e133cb6be129b027265aae7',
'5814cf6b85939f1f00dc9334',
'5f2c813be6ce910029df2817',
'5f00ae5f83b6b2016bdb4978',
'5d0b0475ab110600650d2036',
'5e80d33581efdd0591780814',
'5adafa7d40695d005d4c567b',
'5e49866da527d30809ed63b9',
'5b392d6724c7cc017b1c76fd',
'5ea4b7d1f5976b00d1220560',
'5ecac15962dcc20082825651',
'5ed804a9dde02a002c738685',
'5de6e9d72a9ef9006d44e10c',
'5e48b351f4cd1205f8951f3f',
'5f16039b3b07b000dd280a44',
'5f2acd46b3b60c01a07a02f0',
'5e87915ca8b2ad0035db6a2b',
'5f289cda49dc2200ddfbf930',
'5cbb41d72a4f8500f06c22db',
'562b9ae1a7f738260048c2a5',
'5e9390f46f03bd01a60aacef',
'5dcf473ecd83f0002a5dba76',
'5bee473db4c0bd0061ca81d4',
'5b12ee1d70a12c018a95208f',
'5c8930ee2b2dff002a64436a',
'5f078c6713a6d7002b779c8a',
'5e12abcf519cdc0310781c9a',
'5cc0f474faa9a5002988b367',
'5c6c0e4e556d8400857257a1',
'5e8d39273584230253d3beb1',
'5e4445d2bb4d7f002d92c12c',
'5d951ebb980b09002fe9a628',
'5c490e61c25a1c00319be63f',
'5f56312d52cde1035c841730',
'5e8e755ea08607002d66dda9',
'5680789011844ac301273807',
'5f10db9460d35d00c4e71cf4',
'5c1d3b87039c940030c7cae2',
'5e88f35812d21f0030a41c97',
'5ed3ad7c79774f0033b93248',
'5e16429ba9e54701e3635fc8',
'5e87041332ebd600a523cded',
'5ea63ab3e2f35101a408e0ca',
'5e953346f51c94010400f10d',
'5cb657e130264c002aea3969',
'5ec44e5fe9f0a7002c591c90',
'5e0ce7489ea598010fbcd156',
'5bf2609bdd39cd00295d7235',
'5cfaaeb194c365002a8a0181',
'5aa5ab4d6f26e7017a73fb29',
'5bf1a3ae3e522700f021c908',
'5c5b616ba61435002e224c4e',
'5ba2e7495a6d8d00671f5a41',
'5ee7b8b5b1615003c125a56d',
'5c69ccfb1d55c900295715f2',
'5dc1af99da247d002e19328c',
'5ed87ebcb653a900e7d757e7',
'5e584be3496f8d002a2af277',
'5ce85d697d5d950029faf9ce',
'5f39aecfa88851022f9c6a76',
'5eac4429d1c1fd002ec3d8c7',
'5e1a4d6c924ce8010a3f8a0d',
'5c145509f6649b00c9fc33d1',
'5e775b8e92d8970115dc73d0',
'5ee8e08103199003c9f1fa57',
'5e727399b58ef6003a4557ca',
'58960a6bd89f211d0014b491',
'5ed3dcb417059c0033305939',
'5e39006dcccf7b002a7f435d',
'5c72cae56e8a720028703308',
'5bb7aa912b555a002db2e616',
'5d8bf0810f6caa002a6297cd',
'5c1181cbeb62640029f998db',
'5d5c7f6751d08f002a71eed9',
'5e0ba06542d6af0034b7e3c5',
'5e7bd554aaa462002bf50eb1',
'5dd28564566add014c7a652a',
'5e692432e80f30002c014679',
'586da94ac375542300554086',
'5e9a3acbbbe510002fea04d9',
'5e1f8867361801002bc9cb32',
'5bcfddb02564b80049aef6cb',
'5c704e871d049b005df3af0d',
'5ec035aa29548d01022223a0',
'5e1e41e1d3578c002f8c74eb',
'5eeef2288e330201ac72c38a',
'5de3039d4da42300ced4dcab',
'5ec6d3dbe3777b002c49eca7',
'5de82ab1234e93005a9a66c8',
'5ee4083dc4edc30157e08549',
'5dd6ad971b8c130113f3bd11',
'5eb2f14a1b6ccf002aafa693',
'5f15c00fc92ab202499a1f64',
'5ec0aadb758e7f008e2f45dc',
'5c8695e782f6c4002dd9d552',
'5a4841b27851bd00839f80a0',
'5985dd6892978a0051753340',
'5e5abd1213189b002ae2ba59',
'5f03df54b490c505ee781b23',
'5e20bf2867e16f016c84b812',
'5e38d558b8c0df011da7c89d',
'5de5c3bbe7c2ec002b2b755d',
'5e5ae62933d3b7002bd81f09',
'5dd8a93e15cf8e00826a3fe9',
'5ededba0aa13bc00689c2661',
'5df9977c79c60d002a53d36b',
'5f0f9be75cda33002dc10449',
'5de322db1331e301a37e79bb',
'5c64d6dd68d857002e023b24',
'5de84922fe80210033ccfc8d',
'5ee59a4386395f020df9d492',
'5eb6995512412901b8c08fc3',
'5e4b1978ffc84700a25652c4',
'5f518715b07e61003a0b0092',
'5e1e9453f86e01002b7ac0ed',
'5ee17207487094002958cac9',
'5ebee6c3c88949002a1d6dd6',
'5e7eb87b2926200068ced52f',
'5ef3dc2948c7da005681b396',
'5ebd7e7abecceb00333d559c',
'5dfd050f1bff09002bccaeea',
'5f403317e5b0da002dfd08b1',
'5beb2f47fcf6fb002bebf5de',
'5efac713f14032002990ef6d',
'50b4ece91861fc6255010b7b',
'5e24df705646db04e9855856',
'5de18101bba522002d8da69a',
'5edc08b22ebaf9009e4e4fff',
'5f4bdeec908e8e0038ff5f9a',
'5de1bfa369ef880180bf435c',
'5e1754b85ce706002cc2a6a3',
'5e9f63817667e2002a34f885',
'5ec0202b11728602a0dff127',
'5e7523fc4ea6a0036663f903',
'5ebee8b5324b94002d9b7633',
'5e5d9a75c650570037721635',
'5e375160f8de72050e7f14e3',
'5e07af8218bb6800ea41cdb8',
'5c2d724466efbe002d304f57',
'5eb4cf7c3dee490123ef910f',
'5ded7158dd19c0002a34c048',
'5e55dd4863e851006dbed1f8',
'5c4bbf14d7d640004e5cd9d6',
'5ea06de8de1c5a002da919fd',
'5ea48d6787c38e0125d7761c',
'5ea3124e070027039391fee2',
'5d41c8310f0d91002881e4aa',
'5e614f40bf4cb2002b63d748',
'5e924b92fd10dd002a9f0a02',
'5c27ddbe157b1503b05b8647',
'5e73feaea4c390002ae8029c',
'59f4c8b9f291df003fa3dee0',
'5e2509a8cf5543002d3d8b07',
'5e2de5e5025583002ae98545',
'5b47b1f8e39ec7002847ebbe',
'5f00b45b321991003353fef4',
'5e211a68a3185f002aa9f735',
'5a12a37b92947d003f97b11c',
'5b7b4613e04c70002e550a66',
'5f4ee3f767cf7f0036fda254',
'5f15afc71e54100035387e44',
'5c36855eaf87c9008a2ff609',
'5d1537406178bf002ce836c4',
'5e9d96eaa1b84f0031d819d9',
'5f1a0de0061f8800929be4e2',
'5eae235f34c98b005bc8506e',
'5e383f161a0d6501167c640f',
'5f1f75099ab80d007185dc1d',
'5e8fecb82c3126002e8f9614',
'5f30796f7b10d2026c535410',
'5ebb438258c6d600f445fbbe',
'5ec6ca58a3591b002bf164e4',
'5f1c8c9f73219601c9c1c5b7',
'5ccb42f18fac47002a3cf5a0',
'5ed6851594649a003465b4b4',
'5de1dca006bbcb077490f59c',
'5d47093e9bf047002dcc0429',
'5e46e7da44dd2c002b20b09f',
'5e1750bb394e84002a5b45b8',
'5317f4d99d380a645f00098f',
'5e0fdf7979f156003025d293',
'5df514e22e87ad00e971ad67',
'5f37fbab8879d701439fd674',
'5c6aef8e267316002c947a35',
'5eb158cabe3e46007f0faa44',
'5d65eeb5b18375020b7fb1b8',
'5e7f7a15b6f57700b5302e21',
'5ebdefcde86e20002b58a1dc',
'5df68f39b64d6900c7e05ea5',
'5d3f825376eb460254f753d2',
'5a810b18444c74002a58543b',
'5e1e4cd9f914120030aee444',
'5ea34d0893572c0450f3b1cd',
'5e8fc136b0c5d200363f4f5c',
'5e87a7e085db77009252bc5b',
'5e3e060e95b39800e910cd1a',
'5de6757cac748b00608ab314',
'5e516fbe15925400bd789a58',
'5d8e915c6390f0002f19a6cf',
'5e841e5b229c4002378e6751',
'5ea5c4d7e2f35101a4088af6',
'5ddda9c60f6d72002d443201',
'5e703be0ad37c3002db9820a',
'5cf123e13bd096002a9d3246',
'58cc2af6e94bb82600eb6d8c',
'5c2a8300bfbccf0b6552b7ab',
'5ebadb27a685ae00a842fc2f',
'5f07d069620ba8003027a7ed',
'5e2a0772ea0aa3003a36663a',
'5c6f49aa230695045857accf',
'5c11da29095ad800930e355c',
'5f0a560127895e00bda28e2d',
'5eb5c9bc9bd6b301b2fcee3e',
'5eb60cc512412901b8c055f0',
'5edfd634347c4d003dd4a121',
'5b735ca50faf550042fd658b',
'5e9cd636daa90e002b003b89',
'574a63fb6bb978650099a1ec',
'5ea471c7a7a178002fa2094e',
'5dc30f3c9a4d620028eb2674',
'5e838fd1ae869e005c4b4af5',
'55caa46173200b7f5b8c2cc0',
'5c905999777844002fb95e7b',
'5cfc7f8da090bd02e1d24a80',
'5f4807e457868300357210e6',
'5e8e4aba319e82002f5e32e8',
'5a3ec18402ace6004f55440e',
'5686b1273923352200fd6682',
'54bd6fb3ea97ac183f1f251b',
'5e9ce6dc3944a3016e223893',
'5ddd7835e6f837002d15d225',
'5e2e232e3d37530ca527fb76',
'5f0e272e23096c003561f480',
'5ef290013a41bc00a8767e95',
'5ad0f29fc5d35d002cc9f20b',
'5cf2dda8c8823c006c7f7fa5',
'5e4f215245ffb9017bb766fe',
'5ec6be4c0af6c00089412f57',
'5ebac9513f00ff0034213998',
'50b4eac0a3dffd9355011ff3',
'5e910dce7b138d00348c2275',
'5ea0b56b974f49002ba10732',
'5c4617f3b1759a00284c02e3',
'5ea0e244d4402b002a446fe8',
'5f3c03bd74fb03002fb840b8',
'5b9ee2fe67575400f8324109',
'5d8016df015c4b003fab4320',
'5ef157922a886f028ac1ea2e',
'5eebd33f92a4ec002edb3dda',
'5eadd080faaa27027770111d',
'5ee26aaf120fce0092340010',
'5f01f2d45441bd01e0702503',
'5ebd750c1d45af002947b986',
'5e5ee67e9039d0002dbe9b8c',
'5f31f2b7e4ada600371f19d1',
'5e8b8bc71345cd008f68d609',
'50b4e5e29f46bb5c550106a6',
'5e52cfd91099e500c90872af',
'5f0e41ef299aef002ee1339f',
'5ea9f85adb0752002bf403d3',
'5dd0aa7f0bc1e100f769ab3a',
'5f2d8e4b45c7a30031e55b81',
'5e9a17bea8f6b0002ab69462',
'5e627de9f80e82030f92f018',
'5dfec880d387b4010f9c8951',
'5de808d365aeb6002c7028a6',
'5ebb198ee1781c003a1502d9',
'5f11c8ee45a3ad00343eb3a4',
'5e06bfc455d02a002feeb215',
'5e17c07a1fabb8002cb2dbed',
'5c488c4d7ecc6e058aa3bb13',
'514908191a197fe41e0003ce',
'5ea0ce980429c300bb8b78a1',
'5e0b40aec24315002c71e4b8',
'5f2d9c89d6869000b8f975be',
'5e8cc5dca98dc80070665728',
'5e7bc2e9b5ef3f0036a85403',
'5ea9b671baf5ec0139e12f99',
'5deaaabadd19c0002a33776b',
'5e3e29b795b39800e910dfd9',
'5e83b12225e6cc002f2cfec1',
'5d1fce6690570d0217356a56',
'5eae11dee350dc002ec4cc71',
'5dc4a81983f394002d08d5b2',
'5ec1ca96e91c5b010f7eaf96',
'5f5aab06c53bb4007d466cd6',
'5e2f680c8e6e57002d84b082',
'5f468848cb5393009fe61d86',
'5ebd339adba52900379eda99',
'5ddc7840c5fae800824a6b1c',
'5eae0286ae96da0133e7af20',
'5c83cb4b7cb1b00028f15aa6',
'5e7eb4b12b3d5e0085e5b680',
'5ebdb6e361bc10009261c632',
'5e1245d2d5b7af0156e8e0a5',
'5c659baa5c3b1600292d3e0c',
'5ebb30d683da4a0080d16cdc',
'5e3364a1e29013002a0f2287',
'5b4f98016a85c000e9eab853',
'5f4cff30daff6b00305eed5c',
'5ace2369fd570e002fc7737b',
'5a9f0f0aa60564002e09cd4b',
'5de1a009cf808a06913d33f3',
'5ec20ed1758e7f008e300507',
'5c9a81eaa7aee5002a8749a4',
'5ec6a2df1a04bf0092dfaa5a',
'5e7f770f9a32b9007d5e2597',
'5ec2b411ce6ba3002a9c56d1',
'5e015a63ac61cf0029384018',
'5f2330aad43eb900315055b5',
'5e59cdc827985d04304d18a2',
'566498c3171cc8d700fd2970',
'5df7dbe3e7df3e003cd10d33',
'5ef4c99746a4e0002c5351fe',
'5ecfc484c54d8300e4bf8492',
'5befef48dd39cd00295c95cf',
'5a933584e2cf0b002d8b1dd0',
'5eb7388a9bd6b301b2fdbc10',
'5c605a0abd605f0029d3e11d',
'5ce1f6d57aaadd002aa76b05',
'5deed0fac999ba01f470fbc2',
'5e37418fe29013002a1110a6',
'5f122f6ffd9dd0002f2bd599',
'5e8008f22926200068cfbd5d',
'5eda8f04baa36500cb09a2d2',
'5ec04d0a83e67e0062df72a2',
'5d9df589f3e11c008c04fdbb',
'5e4700bbca5c92002ad9826f',
'5aa3392c0d70ec0119b21f88',
'5c295855d494740028427231',
'5eb091a53e5f2f00300c5afa',
'5dff920667d789002a0216da',
'5ad18838a80f36002b393f79',
'5bc1ec2403d980004ec2ffb9',
'5df02b8e87fb1f002da30c6a',
'5ddda588f9d544002ca79645',
'5c6c9d4c779d8b002e6a5477',
'5deeff123a937702775abebf',
'5f415e2f96deca017f08fe2d',
'5f1eee235b17f9018908d28d',
'5e9236f9f8743c00661b732d',
'5de1bb3bf6aa7007f45c4700',
'5eb19a236aa3f2002a81447e',
'5f1658fd10fe3e013ed93c54',
'5e0a65827452f704ce202672',
'5eb752a39bd6b301b2fdcd49',
'5cfa813fb929aa0029395a2c',
'5ea5c8a8e2f35101a4088dd6',
'5a5012fdedd41400418cc2a0',
'5eb203cc1b1519002a3b80e9',
'5f57caa4b6748600aa461043',
'5f106552f899650032f22846',
'5d0528fea7820c002a339ac0',
'5f3496ea53d75f002c5fbad6',
'5e50680a39feca002c8186cb',
'5e0696bcbb8217019f711e9c',
'5e50a4623c025d002b383ee0',
'5f21d2416872eb008cabdd1d',
'5c2259a788057c002e9522b3',
'5c1e4b6ac888d101aaa091da',
'5f1f6a8e6a4b46003db57f95',
'5dff93d8d387b4010f9ce26c',
'5ea4c36aa7a178002fa24756',
'5de293cec7c4630655e1ee52',
'58cc55595fe0b02500752da4',
'5e064cdfd19934002dfe3e5f',
'5ec6d0ba5f7199002a5cfdae',
'5d40188cda4fd800c51dc3af',
'5ebec556dc0d750029b988a9',
'58e83be87973fd0023ba5df7',
'5e10eeae874ea8002f2de6ad',
'5dbc892078b29e002ced92ab',
'5e85319b7d349b002d03fbe5',
'5ea5d4204b3fb40033cc7821',
'5a9059efe2a88901574b0569',
'5e093843b16c95019580867d',
'5e224d370c4677023dc3ae8d',
'5e15329e446932002b381d9c',
'5e91161904ef93002a0f0748',
'5f14d5957a61650147d387d9',
'5c0c7738433a64002c58b903',
'5ea8fe08eed7b4002f6e36e2',
'5e30bbb622fda400cb5298ba',
'5c5a1b8b7b0f5b005720c8ee',
'5eefe09dddc47a02e6889832',
'5efeb095aec4c0015f6f2131',
'5e17b1d3bcf3c4002b59311b',
'5c80170a47db44024f8b5ef5',
'5e7435161aca34002ad1cc14',
'554192fb7e634c1e585dd00a',
'5e970f52e70dfa00b8fe061f',
'5ec96154c23afe019543cae1',
'5c2d860c66efbe002d30591b',
'5f56fe6025f1d800c66d2ae4',
'5977464728ebd4001f0827e5',
'59eaf82cef4bd100414ee0d5',
'5e8f65ebea6948003339e6be',
'5e5bf7f1063dd700a8757222',
'5b9e55a5457d4e00274ce7ca',
'5e379e64e29013002a11416c',
'5e5840d67bbc0e00c8e84bc1',
'5c28c5e54c9b4700287df4d2',
'5f3327d311187700fb7960dd',
'5f177721d0b2e2007881553e',
'5f18cf877f72a400b18c6f99',
'5e24e151c800c9002c6d7adb',
'5e1b25aad86dd600297869ad',
'5de6e8f705f3de002c1266ea',
'5e4d9d2cc273cd0150609d1e',
'5bf8290d0e76df004777d567')
)
WHERE domestic_user <> 1
